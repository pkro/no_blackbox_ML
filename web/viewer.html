<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Viewer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<h1>Data Viewer</h1>
<div id="inputContainer">
    <div id="predictedLabelContainer"></div>
</div>
<div id="controlPanel">
    <button onclick="toggleInput()">Toggle input</button>
</div>
<div id="chartContainer"></div>
<div id="tableContainer"></div>

<script src="../common/js_objects/features.js"></script>
<script src="../common/js_objects/minMax.js"></script>

<script src="../common/constants.js"></script>
<script src="../common/utils.js"></script>
<script src="../common/draw.js"></script>
<script src="../common/featureFunctions.js"></script>

<script src="./js/display.js"></script>
<script src="./js/sketchPad.js"></script>

<script src="./chart/math.js"></script>
<script src="./chart/graphics.js"></script>
<script src="./chart/chart.js"></script>

<script>
    const {samples, featureNames} = features;
    const groups = utils.groupBy(samples, 'student_id');

    const inputContainer = document.getElementById('inputContainer');
    const chartContainer = document.getElementById('chartContainer');
    const tableContainer = document.getElementById('tableContainer');
    const predictedLabelContainer = document.getElementById('predictedLabelContainer');
    

    const chartOptions = {
        size: 500,
        axesLabels: featureNames,
        styles: utils.styles,
        transparency: 0.7,
        icon: 'image'
    };

    graphics.generateImages(utils.styles, 10);

    let chart = null;
    setTimeout(() => {
        chart = new Chart(chartContainer, samples, chartOptions, handleClick);
    }, 100);

    for (let student_id in groups) {
        const samples = groups[student_id];
        const studentName = samples[0].student_name;
        createRow(tableContainer, studentName, samples);
    }

    function onDrawingUpdate(paths) {
        const functions = featureFunctions.inUse.map(f => f.function);
        const point = functions.map(f => f(paths));
        utils.normalizePoints([point], minMax);
        const {label, nearestSamples} = classify(point);
        predictedLabelContainer.innerHTML = `Is it a ${label}?`;
        chart.showDynamicPoint(point, label, nearestSamples);
        

    }

    function classify(point) {
        const samplePoints = samples.map(s => s.point);
        const nearestIndices = utils.getNearest(point, samplePoints, 10);
        const nearestSamples = nearestIndices.map(idx=>samples[idx]);
        const labels = nearestSamples.map(s => s.label);
        const counts = {};
        for (let label of labels) {
            counts[label] = counts[label] ? counts[label] + 1 : 1;
        }
        const max = Math.max(...Object.values(counts));
        const label = labels.find(l => counts[l] === max);
        return {label, nearestSamples: nearestSamples};
    }

    const sketchPad = new SketchPad(inputContainer, onDrawingUpdate, 400);

    // add an overlay / blur effect when the sketchPad is displayed
    sketchPad.canvas.style.cssText += `outline: 10000px solid rgba(0,0,0,0.7)`;


</script>
</body>
</html>
